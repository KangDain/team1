<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./css/style.css?v=2" />
  </head>
  <body>
    <a href="./sub1page.html" class="logo" id="sub">Project Team 1</a>

    <div class="right-top">
      <ul>
        <li><input type="search" placeholder="Search" /></li>
        <li>
          <button>저장된 위치 불러오기</button>
        </li>
      </ul>

      <ul id="right-tage">
        <li>
          <a href="./sub1page.html">HOME</a>
        </li>
        <li>
          <a href="./index.html">LOGOUT</a>
        </li>
      </ul>
    </div>

    <div class="profile-area">
      <h2>프로필 편집</h2>
      <!-- 프로필 사진 영역 -->
      <div>
        <img
          id="profile-img"
          src="./img/default-profile.png"
          alt="Profile Picture"
        />
        <br />
        <input type="file" id="profile-pic-upload" accept="image/*" />
      </div>
      <br />
      <!-- 닉네임 변경 -->
      <div>
        <input type="text" id="nickname" placeholder="새 닉네임 입력" />
      </div>
      <br />
      <!-- 저장 버튼 -->
      <button id="save-btn">저장</button>
      <p id="welcome-message"></p>
      <p id="card-count-message"></p>
    </div>

    <div class="profile-right-sub">
      <p class="line">My Playlist</p>
      <button id="add-card-btn">+ Add Card</button>
      <!-- Card 추가 버튼 -->
      <ul id="card-list"></ul>
    </div>

    <div class="overlay"></div>
    <div class="modal-box"></div>
    <ul id="card-list"></ul>

    <script>
      const profileImgElement = document.getElementById("profile-img");
      const profilePicUpload = document.getElementById("profile-pic-upload");
      const nicknameInput = document.getElementById("nickname");
      const saveButton = document.getElementById("save-btn");
      const addCardBtn = document.getElementById("add-card-btn");
      const cardList = document.getElementById("card-list");
      const welcomeMessage = document.getElementById("welcome-message");
      const cardCountMessage = document.createElement("p");
      welcomeMessage.insertAdjacentElement("afterend", cardCountMessage);

      cardList.style.display = "flex";
      cardList.style.flexWrap = "wrap";
      cardList.style.justifyContent = "flex-start";

      const updateCardCount = () => {
        const cardCount = cardList.children.length;
        cardCountMessage.textContent = `현재 카드 개수: ${cardCount}개`;
      };

      const saveCardsToLocalStorage = () => {
        const cards = Array.from(cardList.children).map((card) => {
          const text = card.querySelector(".card-text").textContent;
          return { text };
        });
        localStorage.setItem("cards", JSON.stringify(cards));
      };

      const addCardToDOM = (
        text = "This is a new playlist card.",
        saveToStorage = true
      ) => {
        const newCard = document.createElement("li");
        newCard.innerHTML = `
              <div class="card" style="width: 18rem;">
                  <img src="./img/my_playlist.png" class="card-img-top" alt="Playlist">
                  <div class="card-body">
                      <p class="card-text">${text}</p>
                      <button class="delete-card-btn">Delete</button>
                  </div>
              </div>
            `;

        cardList.appendChild(newCard);

        const deleteBtn = newCard.querySelector(".delete-card-btn");
        deleteBtn.addEventListener("click", () => {
          newCard.remove();
          updateCardCount();
          saveCardsToLocalStorage();
        });

        updateCardCount();

        if (saveToStorage) {
          saveCardsToLocalStorage();
        }
      };

      const loadCards = () => {
        const savedCards = JSON.parse(localStorage.getItem("cards")) || [];
        savedCards.forEach((cardData) => {
          addCardToDOM(cardData.text, false);
        });
        updateCardCount();
      };

      const loadProfileData = () => {
        const savedProfileImg = localStorage.getItem("profileImg");
        const savedNickname = localStorage.getItem("nickname");

        if (savedProfileImg) {
          profileImgElement.src = savedProfileImg;
        }
        if (savedNickname) {
          nicknameInput.value = savedNickname;
          welcomeMessage.textContent = `안녕하세요 ${savedNickname}님 :)`;
        }
        updateCardCount();
      };

      profilePicUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            profileImgElement.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      saveButton.addEventListener("click", () => {
        const file = profilePicUpload.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            localStorage.setItem("profileImg", e.target.result);
          };
          reader.readAsDataURL(file);
        }

        const newNickname = nicknameInput.value.trim();
        if (newNickname) {
          localStorage.setItem("nickname", newNickname);
          welcomeMessage.textContent = `안녕하세요 ${newNickname}님!`;
          alert("프로필이 저장되었습니다!");
        } else {
          alert("닉네임을 입력하세요!");
        }
      });

      addCardBtn.addEventListener("click", () => {
        // Add Card 클릭 시 sub1Page.html로 이동
        window.location.href = "./sub1page.html";
      });

      window.addEventListener("load", () => {
        loadProfileData();
        loadCards();
      });

      document.querySelector(".save-btn").addEventListener("click", () => {
        const playlistTitle = document.querySelector(
          '.input-container input[placeholder="제목을 입력하세요"]'
        ).value;
        const imageName = document.getElementById("file-name").value;
        const inputList = Array.from(
          document.querySelectorAll("#inputList .input-item")
        ).map((item) => ({
          title: item.querySelector('input[placeholder="제목"]').value,
          artist: item.querySelector('input[placeholder="가수"]').value,
          link: item.querySelector(
            'input[placeholder="Youtube 링크를 입력해주세요"]'
          ).value,
        }));
        const location = document.querySelector(
          '.input-field input[placeholder="지도 위에 위치를 선택해주세요"]'
        ).value;

        // 데이터 검증
        if (
          !playlistTitle ||
          !imageName ||
          inputList.length === 0 ||
          !location
        ) {
          alert("모든 정보를 입력해주세요!");
          return;
        }

        const playlistData = {
          title: playlistTitle,
          image: imageName,
          inputs: inputList,
          location: location,
        };

        // localStorage에 저장
        let savedPlaylists =
          JSON.parse(localStorage.getItem("playlists")) || [];
        savedPlaylists.push(playlistData);
        localStorage.setItem("playlists", JSON.stringify(savedPlaylists));

        alert("플레이리스트가 저장되었습니다!");
        window.location.href = "./profilePage.html"; // profilePage로 이동
      });
    </script>
  </body>
</html>
